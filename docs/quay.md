# Overview

Quay is a container and application repository/registry service, used to host
artifacts generated by [Jenkins](./jenkins.md). `solas-container` 
[GitHub](./github/.md) repositories generate container artifacts stored in a
[Quay Container Repository](https://quay.io/repository/). `solas-chart`
repositories generate Helm chart artifacts stored in the
[Quay Application Registry](https://quay.io/application/). Hosting these
artifacts in Quay enables easy sharing with others. This guide will show you how
to create repositories and prepare for Jenkins to take over.

The following assumes a repository that's been duplicated according to the
the [README](../README.md) instructions.

## [Create](https://docs.quay.io/guides/create-repo.html) a Repository in Quay

Artifacts for the Samsung CNCT organization are stored in the `samsung_cnct`
namespace. By convention, the artifact name is driven by the chart or container name. 
For example, the artifact for the container repository `container-zabra` is named 
`zabra-container`. And for the application repository `chart-zabra`, the
artifact is named simply `zabra`. We've chosen this naming convention because the application, not
the container, is generally the artifact we expect users to interact with.

To create a repository, follow the steps below:

* Go to [quay.io](https://quay.io) and login if you are not already logged in

* Click the `+` icon in the top right of the page near your name and select
`New Repository` ![screenshot](images/quay/create_new_repository.png)

* Select `Container Repository` for `solas-container` repositories

* Select `Application Repository` for `solas-chart` repositories

* Choose `samsung_cnct` for the namespace

* Enter the name of the artifact (for example, `zabra-container` or `zabra`)

![screenshot](images/quay/new-repo.png)

* For `Initialize repository` select `(Empty repository)`

* Write a helpful description (it never hurts!)

* Make the repository public or private as appropriate

* Finish creating the repository by clicking `Create Public Repository` or
`Create Private Repository`

## Create a Robot Account

We use robot accounts to authenticate and authorize access to Quay-hosted repositories. 
Jenkins needs access to push artifacts to the registry. We use a different robot account for each repository to improve
auditing and prevent some mistakes, such as a build job accidently publishing to
the wrong repository.

By convention, robot accounts are named after the artifact they're associated
with and the permissions they grant. Dashes are not allowed in robot names, so
they are replaced by underscores. For example, read/write premissions for
the `zabra-container` artifact are named `zabra_container_rw`. The same
permissions for `zabra` are `zabra_rw`.

* Go to your repository's settings
* Under the section ` User and Robot Permissions`
  * Click Create Robot Account from the `Select a team or user` drop-down menu
  * Name your robot according to the convention above
  * Grant the robot `write` access
  * While in settings, click `Owners` from the `Teams` section of the drop-down and grant `admin` privileges

![screenshot](images/quay/zabra-permissions.png)

### Add Kubernetes Secret to production cluster for your robot

To allow Jenkins to use the robot to access Quay, create a Kubernetes Secret. This is preferred over other methods of passing secrets because it
allows us to reuse production Kubernetes processes (e.g. monitoring, logging,
auditing, backups, etc.).

By convention, Kubernetes Secrets are named after the artifact they give
permissions for and the permissions they give. For example,
`quay-robot-zabra-container-rw` or `quay-robot-zabra-rw`.

* Log into the CNCT production cluster using
[these](https://github.com/samsung-cnct/docs/blob/master/cnct/production-kubernetes-cluster.md)
instructions.

* Go to https://quay.io/organization/samsung_cnct?tab=robots and find your
robot.

* Click on Docker Login

* Calculate base64 encoded Docker username and password (the `tr` command may be required on OS X). The username and password can be copied from the displayed command for Docker login. 

```
export HISTCONTROL=ignorespace
 echo -n 'samsung_cnct+zabra_r' | base64 | tr -d '\n' ; echo
 echo -n '<robot's_docker_password>' | base64 | tr -d '\n' ; echo
```

Note the leading space in each echo command sequence. This prevents the
command from being stored in your history when you are using bash, and
is a good security practice.  

  * Create a [Kubernetes Secret](https://kubernetes.io/docs/concepts/configuration/secret/)
to bring this configuration into the cluster. First create a file named `secret.yaml` containing
the values calculated above.

```
apiVersion: v1
kind: Secret
metadata:
  name: quay-robot-zabra-container-rw
  namespace: common-jenkins
type: Opaque
data:
  username: <encoded_docker_username>
  password: <encoded_docker_password>
```

* Then run `kubectl create -f secret.yaml` to create the Secret.

* Finally, if you haven't already done so, head to the Jenkinsfile for your
repo and edit the `robot_secret` to be `quay-robot-zabra-container-rw`
or `quay-robot-zabra-rw`.
